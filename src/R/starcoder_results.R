#!/usr/bin/env Rscript

suppressMessages(library(tidyverse))
suppressMessages(library(extrafont))
suppressMessages(loadfonts())

SYSTEMS = list(
  InCoder="ic",
  StarCoder="sc"
)

data_dir <- "../../data"
csv_dir <- paste0(data_dir, "/notes/csv")
figures_dir <- paste0(data_dir, "/notes/starcoder_figures")

if (!file.exists(figures_dir)) {
  dir.create(figures_dir)
}

################################################################################
# Helper functions
################################################################################

# Read in summary CSVs with the names {prefix}.{system}.csv, and return a tibble
read_summary_csv <- function(prefix, ...) {
  tbls <- Map(function(s) {
    filename <- paste0(prefix, ".", s, ".csv")
    path <- paste0(csv_dir, "/", filename)
    if (file.exists(path)) {
      cat("Reading file:", path, "\n")
      tbl <- read_csv(path, show_col_types=FALSE, ...)
    }
  }, SYSTEMS)
  bind_rows(tbls)
}

# Outputs a tibble in LaTeX format (minus the headers)
# Essentially just adds the & between columns and \\ at the end of each row
save.table <- function(table) {
  file <- paste0(figures_dir, "/", substitute(table))
  table <- table %>% modify_if(is.factor, as.character)
  
  cat("Writing table:", file, "\n")
  cat("% DO NOT MODIFY: this file is generated by an R script\n", file=file)
  for (row in 1:nrow(table)) {
    for (col in 1:ncol(table)) {
      cat(table[[row, col]], file=file, append=TRUE)
      if (col < ncol(table)) cat(" & ", file=file, append=TRUE)
    }
    cat(" \\\\\n", file=file, append=TRUE)
  }
}

rename_system <- function(tbl) {
  tbl %>%
    mutate(System=case_when(str_equal(System, "SantaCoder") ~ "StarCoder",
                            .default = System))
}

filter_untyped_es6 <- function(tbl) {
  tbl %>%
    filter(str_ends(Dataset, "es6")) %>%
    filter(str_detect(Dataset, "untyped")) %>%
    select(!Dataset)
}

reorder_systems <- function(tbl) {
  tbl$System <- factor(tbl$System,
                       levels=names(SYSTEMS))
  arrange(tbl, factor(System, levels=names(SYSTEMS)))
}

format_numbers <- function(tbl) {
  tbl %>%
    mutate(across(where(is.double), scales::label_number(accuracy=0.1))) %>%
    mutate(across(where(is.integer), scales::label_comma()))
}

################################################################################
# Table: package counts, file counts, and lines of code for each dataset
# For StarCoder, we only care about the NeverTyped dataset, which we merge
################################################################################

loc_per_file <- read_csv(paste0(csv_dir, "/", "file_loc.csv"), col_types="ccci") %>%
  filter_untyped_es6()

dataset_summary.tex <- loc_per_file %>%
  group_by(Package) %>%
  summarize(.groups="drop_last", Files=n(), `Lines of code`=sum(`Lines of code`)) %>%
  summarize(Packages=n(), Files=sum(Files), `Lines of code`=sum(`Lines of code`)) %>%
  format_numbers()

save.table(dataset_summary.tex)

################################################################################
# Table: number/percent of packages that type check
################################################################################

typecheck_data_full <- read_summary_csv("typecheck", col_types="ccci")

typecheck_data <- typecheck_data_full %>%
  filter_untyped_es6() %>%
  rename_system()

typecheck_summary <- typecheck_data %>%
  group_by(System) %>%
  summarize(.groups="drop", `Type checks`=sum(`Type checks`), n=n(), Percent=`Type checks` / n * 100) %>%
  reorder_systems() %>%
  format_numbers()

################################################################################
# Table: number/percent of files with no errors
################################################################################

error_data_full <- read_summary_csv("error", col_types="ccccci")

error_data <- error_data_full %>%
  filter_untyped_es6() %>%
  rename_system()

# expand_grid gets every file for every system, then left_join gets the files
# that we attempted to type check, and we full_join that with the error count
# (since the error count doesn't include files with 0 errors)
errors_per_file <- error_data %>%
  group_by(System, Package, File) %>%
  summarize(.groups="drop", Errors=sum(Count)) %>%
  full_join(left_join(typecheck_data,
                      expand_grid(System=names(SYSTEMS), loc_per_file),
                      by=c("System", "Package")),
            by=c("System", "Package", "File")) %>%
  replace_na(list(Errors=0)) %>%
  select(!(`Lines of code`:`Type checks`)) %>%
  arrange(System, Package, File) %>%
  reorder_systems()

errorfree_files_summary <- errors_per_file %>%
  group_by(System) %>%
  summarize(.groups="drop", `No errors`=sum(Errors==0), n=n(), Percent=`No errors` / n * 100) %>%
  reorder_systems() %>%
  format_numbers()

################################################################################
# Table: number/percent of "any" annotations, for files that type check
################################################################################

annotations_data_full <- read_summary_csv("annotation", col_types="cccciiii")

annotations_data <- annotations_data_full %>%
  filter_untyped_es6() %>%
  rename_system()

# Annotations per file, given that the file has no errors
annotations_per_file_summary <- annotations_data %>%
  transmute(System, Package, File, Trivial=as.integer(rowSums(.[4:6])), `Total annotations`) %>%
  inner_join(errors_per_file, by=c("System", "Package", "File")) %>%
  filter(Errors==0) %>%
  select(-Errors) %>%
  group_by(System) %>%
  summarize(.groups="drop", Trivial=sum(Trivial), n=sum(`Total annotations`), Percent=Trivial / n * 100) %>%
  reorder_systems() %>%
  format_numbers()

################################################################################
# Table: combined results table
################################################################################

results.tex <- typecheck_summary %>%
  full_join(errorfree_files_summary, by="System") %>%
  full_join(annotations_per_file_summary, by="System")

save.table(results.tex)
