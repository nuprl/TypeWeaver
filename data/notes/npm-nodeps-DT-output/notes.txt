# Type inference

This directory is a copy of `npm-nodeps`, but with CSV files generated by
DeepTyper for each JavaScript file. Each CSV file contains the tokens and
predicted types for the corresponding JavaScript file.

The type inference was done by executing:

    # starting from the repository root
    cd data/notes/npm-nodeps-DT-output
    python ../../../tools/infer-types.py ../../npm-nodeps-DT-output

`infer-types.py` can be run from any directory, but it outputs logs to its
current working directory.

There are 8824 files total, taking up 51 MB of space. It took about 135 minutes
(with an RTX6000) to run the type inference.

2500 `*.js` files were given as inputs; these are listed in
`type-inf-inputs.txt`.

2467 files ran successfully (i.e. DeepTyper ran without error and produced a
corresponding .csv file); these are listed in `type-inf-success.txt`.

33 files resulted in an error; these are listed in `type-inf-fail.txt` and their
errors collected in `type-inf-errs.txt`.


# Type insertion

This step reads the JavaScript files and their corresponding CSV files, and
inserts the predicted type annotations, outputing TypeScript.

    # starting from the repository root
    cd data/notes/npm-nodeps-DT-output
    python ../../../tools/insert-types.py ../../npm-nodeps-DT-output

`insert-types.py` outputs logs to its current working directory.

Using 16 cores, this step took about 2 minutes.

All 2467 files were successfully converted to TypeScript; these are listed in
`type-ins-success.txt`. There were 0 failures and 0 errors logged.

However, there were 615 warnings in 126 files; these are listed in
`type-ins-warn.txt`. The warnings fall into the following categories:

  - 7 declaration types could not be found
    - 2 cases are using a destructuring pattern in function parameters, and
      type-inserter should be updated to silently skip this
        - async/internal/asyncEachOfLimit.js
        - ret/dist/write-set-tokens.js
    - 1 case is due to an incorrect tokenization by DeepTyper
        - stealthy-require/lib/index.js
          `var modulesToKeep = []` has `modulesToKeep` split into two tokens
    - 4 cases need more investigation (2 files with 2 cases each)
       - deepmerge/dist/umd.js
       - deepmerge/dist/cjs.js
  - 49 functions with default parameters were skipped
  - 559 declaration statements contained multiple declarations and were skipped


# Type checking

TODO: Below text is outdated; we need to run the CSV-to-TS step first before we can type check

After the TypeScript was generated, the next step is to run the TypeScript
compiler to type check the output. This was done by running the included
`type-check.sh` bash script, which individually type checks each file listed in
`type-inf-outputs.txt`:

    # starting from the repository root
    cd data
    ./type-check.sh npm-nodeps-DT-output

Overall, this took about 2 hours to complete.

**Note**: each file, rather than project, was type checked individually.

`@types/node` is a required dependency, since otherwise `module`
(e.g. `module.exports`) is not defined.

330 files type checked successfully; these are listed in `type-check-pass.txt`.
Most of these files are very small, or the type annotations were mostly `any`.
The largest file (`mime/types/other.ts`) is mainly JSON and contains no
declarations. The second largest file (`pako/lib/zlib/inftrees.ts`) contains
declarations, but is mostly code and comments. For some files, DeepTyper was
able to infer types like `string`, `number`, `Function`, and array types.

2137 files failed to type check; these are listed in `type-check-fail.txt`.
There error messages are recorded in `type-check-errs.txt` and there are over
18K lines of errors.

Many of these errors are because the modified DeepTyper output invalid
TypeScript code. But there are also errors where the TypeScript code was
syntactically valid but did not type check (e.g. `aproba/index.ts`, or
`async/internal/DoublyLinkedList.ts` which inferred a type `GridApi` that is not
defined anywhere.)
