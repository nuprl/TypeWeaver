# README

There are four datasets, extracted from the `top1k-plus` dataset:

  * `top1k-typed-nodeps`
    * **288** packages that are typed and have no dependencies
  * `top1k-untyped-nodeps`
    * **102** packages that are untyped and have no dependencies
  * `top1k-typed-with-typed-deps`
    * **92** packages that are typed and all their dependencies are typed
  * `top1k-untyped-with-typed-deps`
    * **42** packages that are untyped and all their dependencies are typed

"Typed" means the package has type definitions in the
[DefinitelyTyped](https://github.com/DefinitelyTyped/DefinitelyTyped)
repository.

`from_tarballs` contains code that was extracted from NPM tarballs, which may be
compiled or minified code. `originals` contains code that was cloned from GitHub
repositories.

The CSV files (located in the `notes` directory), generated by the
`tools/collect_dataset_stats.py` script, contain some basic statistics about
the number of lines of JavaScript and TypeScript code.

Further details are provided below.


## `top1k-plus`

The `top1k-plus` dataset contains the top 1000 most downloaded packages from
NPM, plus additional dependencies to ensure the set is closed. In other words,
all the packages in this dataset either have no dependencies, or depend on a
set of packages that are also in the dataset.

"devDependencies" are not counted as dependencies.

The download stats were scraped from NPM around August 2021. No packages were
filtered out.

There are **1147** packages in this set.

Dependencies were obtained by examining the `package.json` files.
devDependencies and version numbers were ignored.

Using [`jq`](https://stedolan.github.io/jq/), these were the approximate steps:

    ls > pkgs
    for i in `find . -type f -name "package.json"`; do \
        jq -r '.dependencies | keys | join("\n")' $i >> deps; \
    done
    cat deps | sort | uniq > deps_sorted
    diff pkgs deps_sorted | grep ">" | cut -d" " -f2

These steps were repeated until no more new dependencies were discovered.


## Automatic classification

The script `tools/check_dataset_in_definitely_typed.py` collects typing
information for the `top1k-plus` dataset, by checking if the package has type
definitions in DefinitelyTyped, and if the package's dependencies have
definitions in DefinitelyTyped. It also checks that a package contains
JavaScript files and is not simply a package of JSON files or type definitions.
The results were saved in `top1k-plus.csv`:

    python ../tools/check_dataset_in_definitely_typed.py \
        --dataset /path/to/top1k-plus \
        --typings /path/to/DefinitelyTyped \
        > notes/top1k-plus.csv

There were **626** packages that contain code, and either have no dependencies
or all of their dependencies are typed. This dataset was categorized as:

  * 200 typed packages with no dependencies
  * 284 untyped packages with no dependencies
  * 78 typed packages with typed dependencies
  * 64 untyped packages with typed dependencies

These numbers do not match the final dataset counts, because some packages were
excluded, reclassified, or failed to download.


## Downloading package source code

The initial dataset (in the `from_tarballs` directory) is extracted from
tarballs published to NPM. The tarballs contain whatever the author published
to NPM, which may be compiled/minified code, but may also not correspond to the
package's source code.

Therefore, we need to download the original source code from the packages'
GitHub repositories. This is what the `tools/download_pkg_src_from_github.py`
script does:

    for i in `ls from_tarballs`; do \
        mkdir -p originals/$i; \
        python ../tools/download_pkg_src_from_github.py \
            --dataset from_tarballs/$i \
            --output originals/$i; \
    done

The script clones the repository given by

    npm view [package] repository.url

and then deletes the `.git` directory to save space.

Some packages failed to download, for the following reasons:

  * no repository was specified by the package
  * the specified repository was actually a directory within a monorepo
  * the repository no longer exists
  * the repository is private


## Data cleaning and manual reclassification

This process was mostly done by hand, so some packages and files may have been
missed. 102 packages were removed, leaving behind **524** packages in the final
dataset.

### Excluding packages

Packages meeting any of the following criteria were deleted:

  * the package was implemented in TypeScript or CoffeeScript
  * the package was too large, i.e. it had over 10 KLOC of JavaScript or
    TypeScript
  * the package was built from within a monorepo

This is a JavaScript dataset, so we exclude TypeScript and CoffeeScript
projects. We also excluded packages that were too large to handle, which
includes packages with significant amounts of code or packages built from
monorepos. Excluding monorepos also helps us exclude duplicate source
repositories, since multiple packages can refer to the same source code
repository.

### Deleting test files and directories

Directories named `test`, `tests`, or `__tests__` were deleted.
Files named `test.js` were also deleted.

### Manual reclassification

Initially, packages (and dependencies) were considered "typed" if they had
type definitions in DefinitelyTyped. However, some packages ship with their own
type definitions (`.d.ts` files), or generate type definitions from JSDoc.

Packages that contained `.d.ts` files in their repository, or packages that
generate `.d.ts` files were reclassified as "typed." However, package
dependencies were not reclassified. As a result, some packages may have been
incorrectly excluded from the dataset, because their dependencies were
incorrectly classified as untyped.

Packages that generate `.d.ts` files can be found by parsing the `tsconfig.json`
files :

    for i in `find . -type f -name "tsconfig.json"`; do \
        jq -e '.compilerOptions.declaration' $i > /dev/null \
            && echo $i | cut -d'/' -f2; \
    done
